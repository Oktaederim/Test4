<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experten-Tool für RLT-Analyse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .unit-label {
            white-space: nowrap;
            color: #4b5563;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #4b5563;
            transition: all 0.2s;
        }
        .tab.active {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }
        .scheduler-cell {
            width: 100%;
            padding-top: 100%; /* Aspect ratio 1:1 */
            position: relative;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        .scheduler-cell:hover {
            border-color: #9ca3af;
        }
        .cell-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .mode-normal { background-color: #3b82f6; }
        .mode-absenk { background-color: #a5b4fc; }
        .mode-aus { background-color: #e5e7eb; }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #111827;
        }
        .kpi-label {
            font-size: 1rem;
            color: #4b5563;
        }
        .saving-positive { color: #16a34a; }
        .saving-negative { color: #dc2626; }
        /* Custom grid for scheduler */
        .grid-cols-25 {
            grid-template-columns: repeat(25, minmax(0, 1fr));
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Experten-Tool für RLT-Analyse</h1>
            <p class="text-lg text-gray-600 mt-2">Detaillierte Energie- und Kostenanalyse inkl. Feuchteberechnung</p>
        </header>

        <main id="app">
            <!-- EINGABEBEREICH -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-6">1. Eingabeparameter</h2>
                
                <div class="mb-6">
                    <label for="anlagenmodus" class="block text-md font-medium text-gray-700 mb-2">Anlagenmodus</label>
                    <select id="anlagenmodus" class="input-field w-full md:w-1/3">
                        <option value="temp">Nur Temperaturführung (Heizen/Kühlen)</option>
                        <option value="dehumidify">Kühlen und Entfeuchten</option>
                        <option value="humidify">Heizen und Befeuchten</option>
                    </select>
                </div>

                <!-- TABS FÜR SZENARIEN -->
                <div class="flex border-b mb-6">
                    <div id="tab-basis" class="tab active" onclick="switchTab('basis')">Basis-Szenario (Ist)</div>
                    <div id="tab-optimierung" class="tab" onclick="switchTab('optimierung')">Optimierungs-Szenario (Soll)</div>
                </div>

                <!-- FORMULARE -->
                <div id="form-container">
                    <!-- Platzhalter für die beiden Formulare, die per JS eingefügt werden -->
                </div>
            </div>

            <!-- BERECHNUNGSBUTTON -->
            <div class="flex justify-center my-8">
                <button id="calculate-btn" class="bg-blue-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg">
                    Analyse durchführen
                </button>
            </div>

            <!-- ERGEBNISBEREICH -->
            <div id="results-container" class="hidden">
                <!-- ÜBERSICHT / DASHBOARD -->
                <div class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-6">2. Übersicht (Dashboard)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="kpi-card">
                            <h3 class="kpi-label">Gesamtkosten Basis</h3>
                            <p id="kpi-cost-basis" class="kpi-value">0 €/a</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-label">Gesamtkosten Optimierung</h3>
                            <p id="kpi-cost-optimierung" class="kpi-value">0 €/a</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-label">Einsparung</h3>
                            <p id="kpi-saving" class="kpi-value saving-positive">0 €/a</p>
                            <p id="kpi-saving-percent" class="text-lg font-medium saving-positive">(0 %)</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-medium text-gray-700 text-center mb-4">Kostenverteilung (Optimierung)</h3>
                            <canvas id="cost-distribution-chart"></canvas>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-700 text-center mb-4">Szenarienvergleich Jahreskosten</h3>
                            <canvas id="scenario-comparison-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- DETAILBERICHT -->
                <div class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-6">3. Detailbericht</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parameter</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Einheit</th>
                                    <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-r">Basis-Szenario</th>
                                    <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-r">Optimierungs-Szenario</th>
                                    <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l">Einsparung</th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l">Energie [kWh/a]</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kosten [€/a]</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l">Energie [kWh/a]</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kosten [€/a]</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l">Energie [kWh/a]</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kosten [€/a]</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be inserted by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for notifications -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Hinweis</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-message" class="text-sm text-gray-600"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// --- KONSTANTEN UND GLOBALE VARIABLEN ---
const R_d = 287.058; // Gaskonstante für trockene Luft [J/(kg*K)]
const R_w = 461.52; // Gaskonstante für Wasserdampf [J/(kg*K)]
const cp_d = 1.006; // Spezifische Wärmekapazität trockener Luft [kJ/(kg*K)]
const cp_w = 1.86; // Spezifische Wärmekapazität Wasserdampf [kJ/(kg*K)]
const h_v0 = 2501; // Verdampfungsenthalpie von Wasser bei 0°C [kJ/kg]
let costDistributionChart, scenarioComparisonChart;
let activeTab = 'basis';

// --- PSYCHROMETRIE-BIBLIOTHEK ---
const psychroLib = {
    // Sättigungsdampfdruck [Pa] nach Magnus-Formel
    getSaturationVaporPressure(tempC) {
        return 611.2 * Math.exp((17.62 * tempC) / (243.12 + tempC));
    },

    // Absolute Feuchte [g/kg] aus Temperatur [°C] und relativer Feuchte [%]
    getAbsoluteHumidity(tempC, relHum, pressurePa = 101325) {
        if (relHum < 0) relHum = 0;
        const p_sat = this.getSaturationVaporPressure(tempC);
        const p_w = (relHum / 100) * p_sat;
        const x = 0.622 * (p_w / (pressurePa - p_w));
        return x * 1000; // in g/kg
    },

    // Relative Feuchte [%] aus Temperatur [°C] und absoluter Feuchte [g/kg]
    getRelativeHumidity(tempC, absHum_g_kg, pressurePa = 101325) {
        const absHum = absHum_g_kg / 1000; // in kg/kg
        const p_sat = this.getSaturationVaporPressure(tempC);
        const p_w = (absHum * pressurePa) / (0.622 + absHum);
        return (p_w / p_sat) * 100;
    },

    // Enthalpie [kJ/kg] aus Temperatur [°C] und absoluter Feuchte [g/kg]
    getEnthalpyFromAbsHum(tempC, absHum_g_kg) {
        const absHum = absHum_g_kg / 1000; // in kg/kg
        return cp_d * tempC + absHum * (h_v0 + cp_w * tempC);
    },

    // Enthalpie [kJ/kg] aus Temperatur [°C] und relativer Feuchte [%]
    getEnthalpyFromRelHum(tempC, relHum) {
        const absHum_g_kg = this.getAbsoluteHumidity(tempC, relHum);
        return this.getEnthalpyFromAbsHum(tempC, absHum_g_kg);
    },
    
    // Dichte [kg/m³]
    getDensity(tempC, absHum_g_kg, pressurePa = 101325) {
        const tempK = tempC + 273.15;
        const absHum = absHum_g_kg / 1000;
        const p_d = pressurePa / (1 + 0.622 * (absHum / (1-absHum))); // Partialdruck trockene Luft
        const p_w = pressurePa - p_d; // Partialdruck Wasserdampf
        return (p_d / (R_d * tempK)) + (p_w / (R_w * tempK));
    }
};

// --- UI-LOGIK ---
document.addEventListener('DOMContentLoaded', () => {
    const formContainer = document.getElementById('form-container');
    formContainer.innerHTML = createFormHTML('basis') + createFormHTML('optimierung');
    document.getElementById('form-optimierung').style.display = 'none';

    addInputValidation();
    
    document.getElementById('calculate-btn').addEventListener('click', runAnalysis);

    // Modal logic
    document.getElementById('modal-close-btn').addEventListener('click', () => {
        document.getElementById('alert-modal').classList.add('hidden');
    });
});

function showModal(message) {
    document.getElementById('modal-message').textContent = message;
    document.getElementById('alert-modal').classList.remove('hidden');
}

function switchTab(tabName) {
    activeTab = tabName;
    document.getElementById('tab-basis').classList.toggle('active', tabName === 'basis');
    document.getElementById('tab-optimierung').classList.toggle('active', tabName === 'optimierung');
    document.getElementById('form-basis').style.display = tabName === 'basis' ? 'block' : 'none';
    document.getElementById('form-optimierung').style.display = tabName === 'optimierung' ? 'block' : 'none';
}

// --- HTML-GENERIERUNG ---
function createFormHTML(prefix) {
    const title = prefix === 'basis' ? 'Basis-Szenario' : 'Optimierungs-Szenario';
    return `
        <form id="form-${prefix}" data-prefix="${prefix}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6">
                <!-- Allgemeine Anlagenparameter -->
                <div class="lg:col-span-3">
                    <h3 class="text-lg font-semibold text-gray-600 border-b pb-2 mb-4">Allgemeine Anlagenparameter</h3>
                </div>
                ${createInputField(prefix, 'volumenstromNormal', 'Zuluftvolumenstrom Normalbetrieb', 20000, 'm³/h')}
                ${createInputField(prefix, 'volumenstromAbsenk', 'Zuluftvolumenstrom Absenkbetrieb', 10000, 'm³/h')}
                ${createInputField(prefix, 'druckverlust', 'Gesamtdruckverlust Anlage', 1500, 'Pa')}
                ${createInputField(prefix, 'wirkungsgradVentilator', 'Wirkungsgrad Ventilator', 70, '%', {min: 0, max: 100})}
                ${createInputField(prefix, 'wirkungsgradMotor', 'Wirkungsgrad Motor', 90, '%', {min: 0, max: 100})}
                ${createInputField(prefix, 'wirkungsgradWRG', 'Wirkungsgrad WRG', 75, '%', {min: 0, max: 100})}

                <!-- Betriebs- und Klimazustände -->
                <div class="lg:col-span-3 mt-4">
                    <h3 class="text-lg font-semibold text-gray-600 border-b pb-2 mb-4">Betriebs- und Klimazustände</h3>
                </div>
                ${createStatePointField(prefix, 'aussenluftHeiz', 'Zustand Außenluft (Heizperiode)', -5, 80)}
                ${createStatePointField(prefix, 'aussenluftKuehl', 'Zustand Außenluft (Kühlperiode)', 32, 50)}
                ${createStatePointField(prefix, 'abluft', 'Soll-Zustand Raumluft/Abluft', 21, 50)}
                ${createStatePointField(prefix, 'zuluftNormal', 'Soll-Zustand Zuluft (Normal)', 21, 50)}
                ${createStatePointField(prefix, 'zuluftAbsenk', 'Soll-Zustand Zuluft (Absenk)', 18, 50)}
                ${createInputField(prefix, 'heizstunden', 'Heizstunden pro Jahr', 3000, 'h/a')}
                ${createInputField(prefix, 'kuehlstunden', 'Kühlstunden pro Jahr', 1000, 'h/a')}

                <!-- Energiekosten -->
                <div class="lg:col-span-3 mt-4">
                    <h3 class="text-lg font-semibold text-gray-600 border-b pb-2 mb-4">Energiekosten</h3>
                </div>
                ${createInputField(prefix, 'kostenWaerme', 'Kosten Wärmeenergie', 0.12, '€/kWh', {step: 0.001})}
                ${createInputField(prefix, 'kostenKaelte', 'Kosten Kälteenergie', 0.08, '€/kWh', {step: 0.001})}
                ${createInputField(prefix, 'kostenStrom', 'Kosten elektrische Energie', 0.30, '€/kWh', {step: 0.001})}
            </div>
            
            <!-- Betriebszeiten-Planer -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-600 border-b pb-2 mb-4">Betriebsprofil (Wochenplaner)</h3>
                ${createScheduler(prefix)}
            </div>
        </form>
    `;
}

function createInputField(prefix, id, label, value, unit, options = {}) {
    const { min, max, step } = { min: 0, max: 100000, step: 1, ...options };
    return `
        <div>
            <label for="${prefix}-${id}" class="block text-sm font-medium text-gray-700">${label}</label>
            <div class="input-group mt-1">
                <input type="number" id="${prefix}-${id}" value="${value}" min="${min}" max="${max}" step="${step}" class="input-field">
                <span class="unit-label">${unit}</span>
            </div>
        </div>
    `;
}

function createStatePointField(prefix, id, label, temp, hum) {
    return `
        <div class="lg:col-span-1">
            <label class="block text-sm font-medium text-gray-700">${label}</label>
            <div class="grid grid-cols-3 gap-2 mt-1">
                <div class="col-span-1">
                    <div class="input-group">
                        <input type="number" id="${prefix}-${id}-temp" value="${temp}" step="0.5" min="-40" max="60" class="input-field" title="Temperatur">
                        <span class="unit-label">°C</span>
                    </div>
                </div>
                <div class="col-span-2 flex items-center gap-2">
                    <div class="input-group">
                        <input type="number" id="${prefix}-${id}-hum" value="${hum}" step="1" min="0" max="100" class="input-field" title="Feuchte">
                    </div>
                    <select id="${prefix}-${id}-hum-type" class="input-field !w-auto" title="Feuchte-Einheit">
                        <option value="rh" selected>% r.F.</option>
                        <option value="ah">g/kg</option>
                    </select>
                </div>
            </div>
        </div>
    `;
}

function createScheduler(prefix) {
    const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    let html = '<div class="grid grid-cols-25 gap-1 text-xs text-center">';
    // Header
    html += '<div></div>'; // Ecke
    for (let i = 0; i < 24; i++) {
        html += `<div class="font-semibold text-gray-500">${i}</div>`;
    }
    // Rows
    days.forEach((day, dayIndex) => {
        html += `<div class="font-semibold text-gray-500 flex items-center justify-center">${day}</div>`;
        for (let hour = 0; hour < 24; hour++) {
            // Default Betriebszeiten: Mo-Fr 7-18 Uhr Normal, sonst AUS
            let defaultMode = 'aus';
            if (dayIndex < 5 && hour >= 7 && hour < 18) {
                defaultMode = 'normal';
            }
            html += `
                <div class="scheduler-cell mode-${defaultMode}" data-prefix="${prefix}" data-day="${dayIndex}" data-hour="${hour}" onclick="cycleMode(this)">
                    <div class="cell-content"></div>
                </div>`;
        }
    });
    html += '</div>';
     html += `
        <div class="flex items-center justify-center gap-6 mt-4 text-sm">
            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full mode-normal"></div> Normal</div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full mode-absenk"></div> Absenk</div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full mode-aus"></div> AUS</div>
        </div>
    `;
    return html;
}

// --- EINGABEVALIDIERUNG UND INTERAKTIVITÄT ---
function addInputValidation() {
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', () => {
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            let value = parseFloat(input.value);

            if (!isNaN(value)) {
                if (value < min) input.value = min;
                if (value > max) input.value = max;
            }
        });
    });
}

const modes = ['normal', 'absenk', 'aus'];
function cycleMode(cell) {
    let currentMode = '';
    modes.forEach(mode => {
        if (cell.classList.contains(`mode-${mode}`)) {
            currentMode = mode;
        }
    });
    
    const currentIndex = modes.indexOf(currentMode);
    const nextIndex = (currentIndex + 1) % modes.length;
    
    cell.classList.remove(`mode-${currentMode}`);
    cell.classList.add(`mode-${modes[nextIndex]}`);
}

// --- HAUPTBERECHNUNGSLOGIK ---
function runAnalysis() {
    const basisData = calculateScenario('basis');
    const optimierungData = calculateScenario('optimierung');

    if (!basisData || !optimierungData) {
        showModal("Bitte überprüfen Sie Ihre Eingaben. Eine Berechnung war nicht möglich.");
        return;
    }
    
    const savings = calculateSavings(basisData, optimierungData);

    displayResults(basisData, optimierungData, savings);
    document.getElementById('results-container').classList.remove('hidden');
    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
}

function getInputs(prefix) {
    const data = {};
    const form = document.getElementById(`form-${prefix}`);
    form.querySelectorAll('input, select').forEach(el => {
        const id = el.id.replace(`${prefix}-`, '');
        data[id] = el.type === 'number' ? parseFloat(el.value) : el.value;
    });
    return data;
}

function getStatePoint(prefix, id) {
    const temp = parseFloat(document.getElementById(`${prefix}-${id}-temp`).value);
    const hum = parseFloat(document.getElementById(`${prefix}-${id}-hum`).value);
    const humType = document.getElementById(`${prefix}-${id}-hum-type`).value;
    
    let absHum_g_kg, relHum, enthalpy;

    if (humType === 'rh') {
        relHum = hum;
        absHum_g_kg = psychroLib.getAbsoluteHumidity(temp, relHum);
        enthalpy = psychroLib.getEnthalpyFromRelHum(temp, relHum);
    } else { // ah
        absHum_g_kg = hum;
        relHum = psychroLib.getRelativeHumidity(temp, absHum_g_kg);
        enthalpy = psychroLib.getEnthalpyFromAbsHum(temp, absHum_g_kg);
    }
    return { temp, relHum, absHum_g_kg, enthalpy };
}

function getSchedulerHours(prefix) {
    const hours = { normal: 0, absenk: 0, aus: 0 };
    document.querySelectorAll(`.scheduler-cell[data-prefix="${prefix}"]`).forEach(cell => {
        if (cell.classList.contains('mode-normal')) hours.normal++;
        else if (cell.classList.contains('mode-absenk')) hours.absenk++;
        else hours.aus++;
    });
    return hours;
}

function calculateScenario(prefix) {
    const i = getInputs(prefix);
    const anlagenmodus = document.getElementById('anlagenmodus').value;

    // Zustandspunkte holen
    const aussenluftHeiz = getStatePoint(prefix, 'aussenluftHeiz');
    const aussenluftKuehl = getStatePoint(prefix, 'aussenluftKuehl');
    const abluft = getStatePoint(prefix, 'abluft');
    const zuluftNormal = getStatePoint(prefix, 'zuluftNormal');
    const zuluftAbsenk = getStatePoint(prefix, 'zuluftAbsenk');

    // Betriebsstunden aus Planer
    const weeklyHours = getSchedulerHours(prefix);
    const totalOpHours = weeklyHours.normal + weeklyHours.absenk;
    if (totalOpHours === 0) return createEmptyResult(); // Keine Betriebsstunden -> keine Kosten

    const ratioNormal = weeklyHours.normal / totalOpHours;
    const ratioAbsenk = weeklyHours.absenk / totalOpHours;

    const h_normal_heiz = ratioNormal * i.heizstunden;
    const h_absenk_heiz = ratioAbsenk * i.heizstunden;
    const h_normal_kuehl = ratioNormal * i.kuehlstunden;
    const h_absenk_kuehl = ratioAbsenk * i.kuehlstunden;

    // Berechnung für Normalbetrieb
    const resNormal = calculateMode(
        i.volumenstromNormal, i.druckverlust, i.wirkungsgradVentilator, i.wirkungsgradMotor, i.wirkungsgradWRG,
        aussenluftHeiz, aussenluftKuehl, abluft, zuluftNormal,
        h_normal_heiz, h_normal_kuehl, i.kostenWaerme, i.kostenKaelte, i.kostenStrom, anlagenmodus
    );

    // Berechnung für Absenkbetrieb
    const resAbsenk = calculateMode(
        i.volumenstromAbsenk, i.druckverlust, i.wirkungsgradVentilator, i.wirkungsgradMotor, i.wirkungsgradWRG,
        aussenluftHeiz, aussenluftKuehl, abluft, zuluftAbsenk,
        h_absenk_heiz, h_absenk_kuehl, i.kostenWaerme, i.kostenKaelte, i.kostenStrom, anlagenmodus
    );
    
    // Gesamtergebnis zusammenfassen
    return {
        energyFan: resNormal.energyFan + resAbsenk.energyFan,
        costFan: resNormal.costFan + resAbsenk.costFan,
        energyHeat: resNormal.energyHeat + resAbsenk.energyHeat,
        costHeat: resNormal.costHeat + resAbsenk.costHeat,
        energyCool: resNormal.energyCool + resAbsenk.energyCool,
        costCool: resNormal.costCool + resAbsenk.costCool,
        totalCost: (resNormal.costFan + resAbsenk.costFan) + (resNormal.costHeat + resAbsenk.costHeat) + (resNormal.costCool + resAbsenk.costCool)
    };
}

function calculateMode(volumenstrom, druckverlust, etaVent, etaMotor, etaWRG, aussenHeiz, aussenKuehl, abluft, zuluft, h_heiz, h_kuehl, costW, costK, costS, anlagenmodus) {
    if (volumenstrom === 0) return { energyFan: 0, costFan: 0, energyHeat: 0, costHeat: 0, energyCool: 0, costCool: 0 };

    // Elektrische Leistung Ventilator [kW]
    const powerFan = (volumenstrom * druckverlust) / (3600 * 1000 * (etaVent / 100) * (etaMotor / 100));
    const energyFan = powerFan * (h_heiz + h_kuehl);
    const costFan = energyFan * costS;

    // Thermische Leistung
    // Heizfall
    const tempNachWRG_Heiz = aussenHeiz.temp + (etaWRG / 100) * (abluft.temp - aussenHeiz.temp);
    const hNachWRG_Heiz = psychroLib.getEnthalpyFromAbsHum(tempNachWRG_Heiz, aussenHeiz.absHum_g_kg);
    const rhoHeiz = psychroLib.getDensity(aussenHeiz.temp, aussenHeiz.absHum_g_kg);
    const massenstromHeiz = (volumenstrom * rhoHeiz) / 3600;
    let powerHeat = 0;
    if (zuluft.enthalpy > hNachWRG_Heiz) {
        powerHeat = massenstromHeiz * (zuluft.enthalpy - hNachWRG_Heiz);
    }
    const energyHeat = powerHeat * h_heiz;
    const costHeat = energyHeat * costW;

    // Kühlfall
    const tempNachWRG_Kuehl = aussenKuehl.temp - (etaWRG / 100) * (aussenKuehl.temp - abluft.temp);
    const hNachWRG_Kuehl = psychroLib.getEnthalpyFromAbsHum(tempNachWRG_Kuehl, aussenKuehl.absHum_g_kg);
    const rhoKuehl = psychroLib.getDensity(aussenKuehl.temp, aussenKuehl.absHum_g_kg);
    const massenstromKuehl = (volumenstrom * rhoKuehl) / 3600;
    let powerCool = 0;
    if (zuluft.enthalpy < hNachWRG_Kuehl) {
        powerCool = massenstromKuehl * (hNachWRG_Kuehl - zuluft.enthalpy);
    }
    const energyCool = powerCool * h_kuehl;
    const costCool = energyCool * costK;

    return { energyFan, costFan, energyHeat, costHeat, energyCool, costCool };
}

function calculateSavings(basis, optimierung) {
    const savings = {};
    for (const key in basis) {
        savings[key] = basis[key] - optimierung[key];
    }
    return savings;
}

function createEmptyResult() {
    return { energyFan: 0, costFan: 0, energyHeat: 0, costHeat: 0, energyCool: 0, costCool: 0, totalCost: 0 };
}

// --- ERGEBNISDARSTELLUNG ---
function displayResults(basis, optimierung, savings) {
    // KPIs
    document.getElementById('kpi-cost-basis').textContent = `${formatNumber(basis.totalCost)} €/a`;
    document.getElementById('kpi-cost-optimierung').textContent = `${formatNumber(optimierung.totalCost)} €/a`;
    document.getElementById('kpi-saving').textContent = `${formatNumber(savings.totalCost)} €/a`;
    const savingPercent = basis.totalCost > 0 ? (savings.totalCost / basis.totalCost) * 100 : 0;
    document.getElementById('kpi-saving-percent').textContent = `(${formatNumber(savingPercent, 1)} %)`;
    
    const savingKpi = document.getElementById('kpi-saving');
    const savingPercentKpi = document.getElementById('kpi-saving-percent');
    savingKpi.classList.toggle('saving-positive', savings.totalCost >= 0);
    savingKpi.classList.toggle('saving-negative', savings.totalCost < 0);
    savingPercentKpi.classList.toggle('saving-positive', savings.totalCost >= 0);
    savingPercentKpi.classList.toggle('saving-negative', savings.totalCost < 0);

    // Charts
    updateCharts(basis, optimierung);

    // Detailbericht
    const tableBody = document.getElementById('report-table-body');
    tableBody.innerHTML = '';
    const totalEnergyBasis = basis.energyFan + basis.energyHeat + basis.energyCool;
    const totalEnergyOpt = optimierung.energyFan + optimierung.energyHeat + optimierung.energyCool;
    
    tableBody.innerHTML += createReportRow('Ventilator-Energie', 'kWh/a', basis.energyFan, basis.costFan, optimierung.energyFan, optimierung.costFan, savings.energyFan, savings.costFan);
    tableBody.innerHTML += createReportRow('Therm. Energie (Heizen)', 'kWh/a', basis.energyHeat, basis.costHeat, optimierung.energyHeat, optimierung.costHeat, savings.energyHeat, savings.costHeat);
    tableBody.innerHTML += createReportRow('Therm. Energie (Kühlen)', 'kWh/a', basis.energyCool, basis.costCool, optimierung.energyCool, optimierung.costCool, savings.energyCool, savings.costCool);
    tableBody.innerHTML += createReportRow('Gesamt', 'kWh/a', totalEnergyBasis, basis.totalCost, totalEnergyOpt, optimierung.totalCost, savings.totalCost, savings.totalCost, true);
}

function createReportRow(label, unit, energyB, costB, energyO, costO, energyS, costS, isTotal = false) {
    const fw = isTotal ? 'font-bold' : '';
    return `
        <tr class="${fw}">
            <td class="px-6 py-4 whitespace-nowrap">${label}</td>
            <td class="px-6 py-4 whitespace-nowrap">${unit}</td>
            <td class="px-6 py-4 whitespace-nowrap border-l">${formatNumber(energyB)}</td>
            <td class="px-6 py-4 whitespace-nowrap">${formatNumber(costB)}</td>
            <td class="px-6 py-4 whitespace-nowrap border-l">${formatNumber(energyO)}</td>
            <td class="px-6 py-4 whitespace-nowrap">${formatNumber(costO)}</td>
            <td class="px-6 py-4 whitespace-nowrap border-l">${formatNumber(energyS)}</td>
            <td class="px-6 py-4 whitespace-nowrap">${formatNumber(costS)}</td>
        </tr>
    `;
}

function updateCharts(basis, optimierung) {
    const ctxCost = document.getElementById('cost-distribution-chart').getContext('2d');
    const ctxScenario = document.getElementById('scenario-comparison-chart').getContext('2d');

    if (costDistributionChart) costDistributionChart.destroy();
    costDistributionChart = new Chart(ctxCost, {
        type: 'doughnut',
        data: {
            labels: ['Ventilator', 'Heizen', 'Kühlen'],
            datasets: [{
                label: 'Kostenverteilung',
                data: [optimierung.costFan, optimierung.costHeat, optimierung.costCool],
                backgroundColor: ['#3b82f6', '#ef4444', '#f97316'],
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    if (scenarioComparisonChart) scenarioComparisonChart.destroy();
    scenarioComparisonChart = new Chart(ctxScenario, {
        type: 'bar',
        data: {
            labels: ['Basis-Szenario', 'Optimierungs-Szenario'],
            datasets: [{
                label: 'Jahreskosten in €',
                data: [basis.totalCost, optimierung.totalCost],
                backgroundColor: ['#6b7280', '#16a34a'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { callback: value => `${value} €` } } }
        }
    });
}

function formatNumber(num, decimals = 0) {
    if (isNaN(num)) return '0';
    return num.toLocaleString('de-DE', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

</script>
</body>
</html>
