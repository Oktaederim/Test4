<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anlagenrechner Lüftungs-/Klimaanlage</title>
<style>
  :root{
    --bg:#0f1216; --card:#161b22; --ink:#e6edf3; --ink-dim:#9aa7b2;
    --accent:#4cb3ff; --line:#2b3138; --warn:#ffca58; --bad:#ff7a7a; --good:#6ee7a1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.35}
  header{padding:20px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(15,18,22,0.9))}
  h1{margin:0;font-size:clamp(18px,2.8vw,28px);letter-spacing:0.2px}
  main{padding:16px;max-width:1200px;margin:0 auto;display:grid;gap:16px;grid-template-columns:1fr}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:980px){.cols-3{grid-template-columns:1fr}.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .card h2{margin:2px 0 8px;font-size:18px}
  .card h3{margin:6px 0 8px;font-size:15px;color:var(--ink-dim)}
  label{display:flex;gap:6px;align-items:center;font-size:13px;color:var(--ink-dim)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0c1014;color:var(--ink);font-size:14px;outline:none}
  input:invalid{border-color:#de6565}
  .row{display:grid;gap:8px;grid-template-columns:1fr 1fr}
  .hint{font-size:12px;color:var(--ink-dim)}
  .muted{color:var(--ink-dim)}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0c1014;color:var(--ink);cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--line);text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .kpi .tile{background:#0c1014;border:1px solid var(--line);border-radius:10px;padding:10px}
  .tile .big{font-size:20px;margin-top:6px}
  .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
  .switch{display:flex;gap:8px;align-items:center}
  .switch input{width:auto}
  .note{font-size:12px;color:var(--ink-dim);margin-top:6px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>📊 Anlagenrechner – Lüftungs-/Klimaanlage (mit WRG, Vorwärmer, Kühler, Nacherhitzer)</h1>
</header>

<main>
  <section class="card">
    <h2>Eingaben – Luft & Sollwerte</h2>
    <div class="grid cols-3">
      <div>
        <label>Außenlufttemperatur T<sub>außen</sub> [°C]</label>
        <input id="T_out" type="number" step="0.1" value="30">
      </div>
      <div>
        <label>Außenluft-Relative Feuchte φ<sub>außen</sub> [%]</label>
        <input id="RH_out" type="number" step="0.1" value="50" min="0" max="100">
      </div>
      <div>
        <label>Volumenstrom V̇ [m³/h] (bis 50 000)</label>
        <input id="Vdot" type="number" step="1" value="12000" min="0" max="50000">
      </div>

      <div>
        <label>Soll-Zulufttemperatur T<sub>ZU</sub> [°C]</label>
        <input id="T_sup_set" type="number" step="0.1" value="20">
      </div>

      <div>
        <label class="inline">Zuluft-Feuchtesollwert
          <select id="hum_mode">
            <option value="rh">φ [% r.F.]</option>
            <option value="gkg">x [g/kg<sub>tr</sub>]</option>
          </select>
        </label>
        <input id="hum_set" type="number" step="0.1" value="45">
      </div>

      <div>
        <label>Solltemperatur hinter WRG T<sub>WRG,out</sub> [°C]</label>
        <input id="T_after_wrg_set" type="number" step="0.1" value="18">
      </div>
    </div>
    <div class="note">Atmosphärischer Druck wird mit 101 325 Pa angenommen. WRG behandelt nur <b>sensible</b> Übertragung (kein Feuchteeintrag).</div>
  </section>

  <section class="card">
    <h2>Wasser-Parameter (für Volumenstrom-Berechnung)</h2>
    <div class="grid cols-3">
      <div>
        <h3>Heizkreis (Vorwärmer & Nacherhitzer)</h3>
        <label>Vorlauf T<sub>VL,HZ</sub> [°C]</label>
        <input id="T_vl_heat" type="number" step="0.1" value="70">
        <label>ΔT wasserseitig Heizen [K]</label>
        <input id="dT_heat" type="number" step="0.1" value="10" min="1">
      </div>
      <div>
        <h3>WRG-Kreis</h3>
        <label>Vorlauf T<sub>VL,WRG</sub> [°C]</label>
        <input id="T_vl_wrg" type="number" step="0.1" value="20">
        <label>ΔT wasserseitig WRG [K]</label>
        <input id="dT_wrg" type="number" step="0.1" value="5" min="1">
      </div>
      <div>
        <h3>Kaltwasserkreis (Kühler)</h3>
        <label>Vorlauf T<sub>VL,KW</sub> [°C]</label>
        <input id="T_vl_cool" type="number" step="0.1" value="6">
        <label>ΔT wasserseitig Kühlen [K]</label>
        <input id="dT_cool" type="number" step="0.1" value="6" min="1">
      </div>
    </div>
    <div class="footer">
      <button id="calc" class="btn">➡️ Berechnen</button>
      <div class="hint">Hinweis: Wasser-Volumenstrom = Q / (ρ·c<sub>p</sub>·ΔT); ρ=1000 kg/m³, c<sub>p</sub>=4.186 kJ/(kg·K)</div>
    </div>
  </section>

  <section class="card">
    <h2>KPIs – Überblick</h2>
    <div class="kpi" id="kpis">
      <!-- Filled by JS -->
    </div>
  </section>

  <section class="card">
    <h2>Zustände & Registerleistungen</h2>
    <div class="grid cols-2">
      <div>
        <h3>Luftzustände</h3>
        <table id="airTable">
          <thead>
            <tr><th>Position</th><th>T [°C]</th><th>φ [%]</th><th>x [g/kg<sub>tr</sub>]</th><th>h [kJ/kg<sub>tr</sub>]</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3>Register</h3>
        <table id="coilTable">
          <thead>
            <tr><th>Register</th><th>Leistung Q [kW]</th><th>Wasser V̇ [m³/h]</th><th>VL [°C]</th><th>RL [°C]</th><th>Bemerkung</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="note" id="notes"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Summen</h2>
    <div class="grid cols-2">
      <div class="tile">
        <div>Gesamt-Kühlleistung</div>
        <div id="Q_cool_sum" class="big"></div>
      </div>
      <div class="tile">
        <div>Gesamt-Heizleistung</div>
        <div id="Q_heat_sum" class="big"></div>
      </div>
    </div>
  </section>
</main>

<script>
/* ========= Psychrometrie – Hilfsfunktionen ========= */
const P_ATM = 101325;                 // Pa
const R_DA = 287.058;                 // J/(kg·K) trockene Luft
const R_V  = 461.495;                 // J/(kg·K) Wasserdampf
const CP_A = 1.006;                   // kJ/(kgtr·K) trockene Luft
const CP_V = 1.86;                    // kJ/(kgtr·K) Dampf-Beitrag per kgtr pro K
const RHO_W = 1000;                   // kg/m3
const CP_W  = 4.186;                  // kJ/(kg·K)

/** Sättigungsdampfdruck über Wasser [Pa] – Tetens (gut für 0–50 °C) */
function p_ws(Tc){
  return 610.94 * Math.exp(17.625*Tc/(Tc+243.04));
}
/** Feuchteverhältnis W [kg/kgtr] aus T [°C] und φ [%] */
function W_from_T_RH(Tc, RH, p=P_ATM){
  const pws = p_ws(Tc);
  const pv = Math.max(0, Math.min(1, RH/100))*pws;
  return 0.62198 * pv / (p - pv);
}
/** relative Feuchte φ [%] aus T [°C] und W */
function RH_from_T_W(Tc, W, p=P_ATM){
  const pv = p * W / (0.62198 + W);
  return 100 * pv / p_ws(Tc);
}
/** Enthalpie feuchter Luft [kJ/kgtr] */
function h_moist(Tc, W){
  return CP_A*Tc + W*(2501 + CP_V*Tc);
}
/** spezifische Wärmekapazität feuchter Luft [kJ/kgtrK] */
function cp_moist(W){
  return CP_A + W*CP_V;
}
/** Dichte feuchter Luft [kg/m3] bei T [°C], W */
function rho_moist(Tc, W, p=P_ATM){
  const T = Tc + 273.15;
  const pv = p * W / (0.62198 + W);
  const pd = p - pv;
  return pd/(R_DA*T) + pv/(R_V*T);
}
/** Taupunkt [°C] zu gegebenem W – numerisch */
function dewpoint_from_W(W, p=P_ATM){
  // Solve Ws(T) = W
  let lo = -30, hi = 60;
  for(let i=0;i<60;i++){
    const mid = (lo+hi)/2;
    const Ws_mid = 0.62198 * p_ws(mid) / (p - p_ws(mid));
    if(Ws_mid > W) hi = mid; else lo = mid;
  }
  return (lo+hi)/2;
}
/** clamp helper */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
/** round helper */
function r(x,dec=2){ return (Math.round(x*10**dec)/10**dec).toFixed(dec); }

/* ========= UI & Berechnung ========= */
function readInputs(){
  const T_out = parseFloat(document.getElementById('T_out').value);
  const RH_out = clamp(parseFloat(document.getElementById('RH_out').value),0,100);
  const Vdot_m3h = clamp(parseFloat(document.getElementById('Vdot').value),0,50000);
  const T_sup_set = parseFloat(document.getElementById('T_sup_set').value);
  const hum_mode = document.getElementById('hum_mode').value;
  const hum_set = parseFloat(document.getElementById('hum_set').value);
  const T_after_wrg_set = parseFloat(document.getElementById('T_after_wrg_set').value);

  const T_vl_heat = parseFloat(document.getElementById('T_vl_heat').value);
  const dT_heat = Math.max(0.1, parseFloat(document.getElementById('dT_heat').value));
  const T_vl_wrg = parseFloat(document.getElementById('T_vl_wrg').value);
  const dT_wrg = Math.max(0.1, parseFloat(document.getElementById('dT_wrg').value));
  const T_vl_cool = parseFloat(document.getElementById('T_vl_cool').value);
  const dT_cool = Math.max(0.1, parseFloat(document.getElementById('dT_cool').value));

  // Ziel-W aus Soll (RH oder g/kg)
  let W_sup_target;
  if(hum_mode==='rh'){
    W_sup_target = W_from_T_RH(T_sup_set, hum_set);
  }else{
    W_sup_target = Math.max(0, hum_set/1000); // g/kg -> kg/kg
  }
  return {T_out,RH_out,Vdot_m3h,T_sup_set,hum_mode,hum_set,W_sup_target,T_after_wrg_set,
          T_vl_heat,dT_heat,T_vl_wrg,dT_wrg,T_vl_cool,dT_cool};
}

function calc(){
  const inp = readInputs();
  const notes = [];
  // ---- Außenluft Zustand 0
  const W0 = W_from_T_RH(inp.T_out, inp.RH_out);
  const h0 = h_moist(inp.T_out, W0);
  const rho0 = rho_moist(inp.T_out, W0);
  const Vdot_m3s = inp.Vdot_m3h/3600;
  const mdot_moist = rho0 * Vdot_m3s;         // kg_feuchte_Luft/s
  const mdot_dry = mdot_moist / (1+W0);       // kgtr/s

  // ---- Vorwärmer auf 5°C (Filterschutz)
  let T1 = inp.T_out;
  let Q_pre = 0;
  if(inp.T_out < 5){
    T1 = 5;
    const W1 = W0;
    const h1 = h_moist(T1, W1);
    Q_pre = mdot_dry * (h1 - h0); // kW, da h in kJ/kgtr
  }
  const W1 = W0;
  const h1 = h_moist(T1, W1);

  // ---- WRG (nur sensibel) auf Solltemp nach WRG
  const T2 = inp.T_after_wrg_set;
  const W2 = W1;
  const cp2 = cp_moist(W2);
  const Q_wrg = mdot_dry * cp2 * (T2 - T1); // kW (+ heizen, - kühlen)
  const h2 = h_moist(T2, W2);

  // ---- Kühler & Nacherhitzer zur Erreichung der Zuluft-Sollwerte
  const Tz_set = inp.T_sup_set;
  const Wz_target = inp.W_sup_target;

  // Plausibilität: gewählter Zuluft-Soll (T,RH/gkg) muss physikalisch möglich sein
  const Tdp_target = dewpoint_from_W(Wz_target);
  if(Tz_set < Tdp_target - 0.05){
    notes.push(`⚠️ Unmöglich: Bei T_ZU=${r(Tz_set)}°C ist x_ZU=${r(Wz_target*1000,2)} g/kg nicht erreichbar (Taupunkt dazu ≈ ${r(Tdp_target)}°C). Bitte RH/g/kg oder T_ZU anpassen.`);
  }

  let coil_used = false;
  let T3 = T2, W3 = W2, h3 = h2;
  let Q_cool = 0, Q_reheat = 0, condensate_kgph = 0;

  if(W2 > Wz_target + 1e-6){ // Entfeuchtung nötig
    coil_used = true;
    const T_coil = Tdp_target; // am Austritt 100% r.F. mit Ziel-x
    const h_coil = h_moist(T_coil, Wz_target);
    if(h2 > h_coil){
      Q_cool = mdot_dry * (h2 - h_coil); // Gesamt (sens+lat)
    } else {
      Q_cool = 0;
    }
    const dW = W2 - Wz_target;
    condensate_kgph = Math.max(0, dW*mdot_dry*3600); // kg/h

    // Nacherhitzer auf Tz_set (falls höher als T_coil)
    if(Tz_set > T_coil){
      const cpz = cp_moist(Wz_target);
      Q_reheat = mdot_dry * cpz * (Tz_set - T_coil);
      T3 = Tz_set; W3 = Wz_target; h3 = h_moist(T3,W3);
    }else{
      // kein Reheat; Zuluft = T_coil (falls Nutzer T_set darunter gesetzt hat)
      T3 = T_coil; W3 = Wz_target; h3 = h_coist = h_coil;
      if(Tz_set < T_coil - 0.05){
        notes.push(`ℹ️ Zulufttemperatur wurde auf ${r(T_coil)}°C begrenzt (Sättigung bei Ziel-Feuchte).`);
      }
    }
  } else {
    // Keine Entfeuchtung – rein sensibel auf Tz_set
    if(T2 > Tz_set + 1e-6){
      coil_used = true;
      const h_target = h_moist(Tz_set, W2);
      Q_cool = mdot_dry * (h2 - h_target); // sensibel
      T3 = Tz_set; W3 = W2; h3 = h_target;
    } else if(T2 < Tz_set - 1e-6){
      const cpz = cp_moist(W2);
      Q_reheat = mdot_dry * cpz * (Tz_set - T2);
      T3 = Tz_set; W3 = W2; h3 = h_moist(T3,W3);
    } // sonst genau getroffen
  }

  // ---- Wasser-Volumenströme & RL-Temperaturen
  function waterFlow_m3ph(QkW, dT){
    // m_dot_w [kg/s] = Q[kW]/(cp[kJ/kgK]*dT[K])
    const mdot_w = Math.abs(QkW) / (CP_W * dT);
    return mdot_w / RHO_W * 3600;
  }
  // Vorwärmer (nur wenn aktiv)
  const Vw_pre = (Q_pre>0) ? waterFlow_m3ph(Q_pre, inp.dT_heat) : 0;
  const RL_pre = (Q_pre>0) ? (inp.T_vl_heat - inp.dT_heat) : NaN;

  // WRG (Vorzeichen kann +/–)
  const Vw_wrg = (Q_wrg!==0) ? waterFlow_m3ph(Q_wrg, inp.dT_wrg) : 0;
  const RL_wrg = (Q_wrg>=0) ? (inp.T_vl_wrg - inp.dT_wrg) : (inp.T_vl_wrg + inp.dT_wrg);

  // Kühler
  const Vw_cool = (Q_cool>0) ? waterFlow_m3ph(Q_cool, inp.dT_cool) : 0;
  const RL_cool = (Q_cool>0) ? (inp.T_vl_cool + inp.dT_cool) : NaN;

  // Nacherhitzer
  const Vw_re = (Q_reheat>0) ? waterFlow_m3ph(Q_reheat, inp.dT_heat) : 0;
  const RL_re = (Q_reheat>0) ? (inp.T_vl_heat - inp.dT_heat) : NaN;

  // ---- Summen
  const Q_cool_sum = (Q_cool > 0 ? Q_cool : 0) + (Q_wrg<0 ? Math.abs(Q_wrg) : 0);
  const Q_heat_sum = (Q_pre>0?Q_pre:0) + (Q_wrg>0?Q_wrg:0) + (Q_reheat>0?Q_reheat:0);

  // ---- Tabellen & KPIs rendern
  const airRows = [
    ["Außenluft", inp.T_out, inp.RH_out, W0*1000, h0],
    ["Nach Vorwärmer", T1, RH_from_T_W(T1,W1), W1*1000, h1],
    ["Nach WRG", T2, RH_from_T_W(T2,W2), W2*1000, h2],
    ["Nach Kühler", (coil_used? (W2>inp.W_sup_target? dewpoint_from_W(inp.W_sup_target):T3):T3),
      RH_from_T_W(coil_used? (W2>inp.W_sup_target? dewpoint_from_W(inp.W_sup_target):T3):T3,
                  coil_used? (W2>inp.W_sup_target? inp.W_sup_target:W2):W2),
      (coil_used? (W2>inp.W_sup_target? inp.W_sup_target:W2):W2)*1000,
      h_moist( coil_used? (W2>inp.W_sup_target? dewpoint_from_W(inp.W_sup_target):T3):T3,
               coil_used? (W2>inp.W_sup_target? inp.W_sup_target:W2):W2 )],
    ["Zuluft (Soll)", T3, RH_from_T_W(T3,W3), W3*1000, h3],
  ];
  const airTbody = document.querySelector("#airTable tbody");
  airTbody.innerHTML = airRows.map(row=>{
    return `<tr><td>${row[0]}</td><td>${r(row[1])}</td><td>${r(row[2])}</td><td>${r(row[3])}</td><td>${r(row[4])}</td></tr>`;
  }).join("");

  const coilRows = [
    ["Vorwärmer (5 °C)", Q_pre, Vw_pre, isNaN(RL_pre)? "-" : r(RL_pre), r(inp.T_vl_heat), Q_pre>0? "aktiv":"aus"],
    ["WRG (sensibel)", Q_wrg, Vw_wrg, r(RL_wrg), r(inp.T_vl_wrg), Q_wrg>0? "Heizfall":"Kühlfall"],
    ["Kühler", Q_cool, Vw_cool, isNaN(RL_cool)? "-" : r(RL_cool), r(inp.T_vl_cool),
      Q_cool>0? (condensate_kgph>0? `Kondensat: ${r(condensate_kgph)} kg/h` : "sensibel"): "aus"],
    ["Nacherhitzer", Q_reheat, Vw_re, isNaN(RL_re)? "-" : r(RL_re), r(inp.T_vl_heat), Q_reheat>0? "aktiv":"aus"],
  ];
  const coilTbody = document.querySelector("#coilTable tbody");
  coilTbody.innerHTML = coilRows.map(row=>{
    const [name,Q,Vw,RL,VL,remark] = row;
    const qstr = `${Q>0? r(Q): (Q<0? ("-"+r(Math.abs(Q))): "0.00")}`;
    return `<tr>
      <td>${name}</td>
      <td>${qstr}</td>
      <td>${Vw>0? r(Vw): "-"}</td>
      <td>${VL}</td>
      <td>${RL}</td>
      <td style="text-align:left">${remark}</td>
    </tr>`;
  }).join("");

  // KPIs
  const kpi = document.getElementById('kpis');
  const phiZU = clamp(RH_from_T_W(T3,W3),0,100);
  kpi.innerHTML = `
    <div class="tile"><div>ṁ (trockene Luft)</div><div class="big">${r(mdot_dry)} kg/s</div></div>
    <div class="tile"><div>ρ (Außenluft)</div><div class="big">${r(rho0,3)} kg/m³</div></div>
    <div class="tile"><div>Kondensat am Kühler</div><div class="big">${condensate_kgph>0? r(condensate_kgph)+" kg/h":"–"}</div></div>
    <div class="tile"><div>T/RH Zuluft</div><div class="big">${r(T3)} °C · ${r(phiZU)} %</div></div>
  `;
  document.getElementById('Q_cool_sum').textContent = `${r(Q_cool_sum)} kW`;
  document.getElementById('Q_heat_sum').textContent = `${r(Q_heat_sum)} kW`;

  document.getElementById('notes').innerHTML = notes.map(n=>`<div>${n}</div>`).join("") || "<span class='muted'>Keine Hinweise.</span>";
}

document.getElementById('calc').addEventListener('click', calc);
window.addEventListener('load', calc);

// Live-Umschaltung Eingabeeinheit (RH vs g/kg)
document.getElementById('hum_mode').addEventListener('change', (e)=>{
  const mode = e.target.value;
  const label = document.querySelector("label[for='hum_set']");
  const input = document.getElementById('hum_set');
  if(mode==='rh'){
    input.value = "45";
  } else {
    input.value = "7.0";
  }
});
</script>
</body>
</html>
